
# 소켓 삭제 및 리소스 정리의 중요성

- 네트워크 소켓은 서버와 클라이언트 간 통신을 가능하게 하는 중요한 요소입니다.
- 하지만 사용하지 않는 소켓을 적절히 정리하지 않으면 시스템 자원 문제, 서버 성능 저하, 그리고 애플리케이션 비정상 종료와 같은 문제가 발생할 수 있습니다.
- 본 문서에서는 소켓을 삭제하거나 정리해야 하는 이유를 구체적으로 설명하고, 이를 위한 실용적인 코드 예제를 제공합니다.

---

## 1. 소켓을 삭제해야 하는 이유

### (1) **리소스 누수(Resource Leak)**
운영 체제는 각 소켓을 **파일 디스크립터(File Descriptor)**로 관리합니다. 사용하지 않는 소켓을 닫지 않으면 해당 파일 디스크립터는 여전히 시스템 자원으로 점유된 상태로 남게 됩니다.

- **문제점**:
    - 시스템에는 사용 가능한 파일 디스크립터의 최대 개수가 제한되어 있습니다.
    - 사용하지 않는 소켓이 닫히지 않으면 새로운 연결 요청을 처리할 수 없게 됩니다.

- **결과**:
    - 서버가 더 이상 클라이언트 연결을 수락하지 못하고, 프로그램에서 아래와 같은 에러가 발생할 수 있습니다.
      ```
      Error: EMFILE: too many open files
      ```

### (2) **메모리 누수(Memory Leak)**
소켓 객체는 데이터를 버퍼링하거나 내부 상태를 저장하는 데 메모리를 사용합니다. 소켓이 닫히지 않고 참조가 계속 유지된다면, 이 메모리는 가비지 컬렉터에 의해 해제되지 않습니다.

- **문제점**:
    - 사용되지 않는 소켓이 많아질수록 서버의 메모리 사용량이 증가합니다.
    - 메모리 부족으로 서버가 강제로 종료될 수 있습니다.

### (3) **서버의 성능 저하**
- 소켓이 적절히 닫히지 않으면 시스템 자원(파일 디스크립터, 메모리 등)이 고갈됩니다.
- 이로 인해 새로운 요청을 처리할 수 없거나, 서버 응답 속도가 느려질 수 있습니다.

---

## 2. 리소스 정리의 중요성

### (1) **안정적인 서버 운영**
서버는 여러 클라이언트와의 동시 연결을 처리해야 합니다. 사용하지 않는 소켓을 정리하지 않으면 서버의 자원이 불필요하게 점유되며, 결국 새로운 연결 요청을 처리하지 못하게 됩니다.

- **예**: 네트워크 연결을 처리하는 서버가 동시 처리 가능한 연결 수를 초과하면 연결 요청이 차단됩니다.

### (2) **애플리케이션의 예측 가능성**
정리되지 않은 소켓은 시간이 지나면서 쌓이게 되고, 이는 애플리케이션의 동작을 예측하기 어렵게 만듭니다. 명시적으로 소켓을 닫고 정리하면 서버의 동작이 더 안정적이고 관리하기 쉬워집니다.

---

## 3. 구체적인 정리 방법

### (1) 연결 종료 시 소켓 삭제

소켓 연결이 종료되면 이를 감지하여 적절히 삭제하거나 참조를 해제해야 합니다.

#### 코드 예제:
```javascript
const activeSockets = new Set(); // 현재 활성 상태의 소켓 저장

server.on('connection', (socket) => {
    activeSockets.add(socket); // 소켓 추가

    socket.on('end', () => {
        console.log('클라이언트 연결 종료');
        activeSockets.delete(socket); // 소켓 제거
    });

    socket.on('error', (err) => {
        console.error('소켓 에러 발생:', err);
        activeSockets.delete(socket); // 에러 발생 시 소켓 제거
    });

    socket.on('close', () => {
        console.log('소켓이 닫혔습니다.');
        activeSockets.delete(socket); // 닫힌 소켓 정리
    });
});
```

### (2) 타임아웃 설정으로 오래된 연결 관리

오랜 시간 동안 응답이 없는 연결은 타임아웃을 통해 자동으로 종료할 수 있습니다.

#### 코드 예제:
```javascript
socket.setTimeout(30000); // 30초 타임아웃 설정

socket.on('timeout', () => {
    console.log('소켓 타임아웃 발생: 연결 종료');
    socket.end(); // 소켓 닫기
});
```

### (3) 명시적으로 참조 해제

자바스크립트에서는 객체에 대한 참조가 유지되면 가비지 컬렉터가 해당 객체를 제거하지 않습니다. 따라서 사용하지 않는 소켓 객체에 대한 참조를 명시적으로 해제해야 합니다.

#### 코드 예제:
```javascript
let socket = net.createConnection({ port: 8080 });

// 연결 종료 시 소켓 참조 해제
socket.on('end', () => {
    console.log('연결 종료');
    socket = null; // 참조 해제
});
```

---

## 4. 잘못된 관리를 방치했을 때 발생할 수 있는 문제

- **시스템 자원 부족**: 소켓이 계속 남아 있으면 시스템은 새로운 연결을 처리하지 못합니다.
- **서버 중단**: 메모리 누수로 인해 서버가 강제로 종료될 수 있습니다.
- **디버깅의 어려움**: 관리되지 않은 소켓이 많아지면 서버의 동작을 예측하기 어렵습니다.

---

## 5. 정리

1. **소켓을 삭제하거나 정리하지 않으면**:
    - 시스템 자원이 고갈되고, 서버 성능이 저하됩니다.
    - 애플리케이션의 안정성이 떨어집니다.

2. **정리 방법**:
    - 소켓 연결 종료 시 `socket.end()`로 명시적으로 닫기.
    - 타임아웃을 설정해 장시간 연결을 자동으로 종료.
    - 객체 참조를 해제하여 메모리를 가비지 컬렉터가 회수할 수 있도록 하기.

3. **결론**:
   소켓 삭제와 정리는 네트워크 서버를 안정적이고 효율적으로 운영하기 위한 필수 작업입니다.

---
