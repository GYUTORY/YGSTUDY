# 레이스 컨디션 (Race Condition)

## 정의
레이스 컨디션이란 두 개 이상의 프로세스나 스레드가 공유 자원에 동시에 접근할 때, 실행 순서에 따라 결과가 달라질 수 있는 상황을 말합니다. 이는 병렬 프로그래밍에서 가장 흔한 문제 중 하나입니다.

## 발생 원인
1. **공유 자원의 동시 접근**
   - 여러 프로세스/스레드가 동일한 메모리 공간이나 파일에 접근할 때 발생
   - 특히 읽기/쓰기 작업이 동시에 일어날 때 문제가 됨

2. **비원자적(Atomic) 연산**
   - 하나의 연산이 여러 단계로 나뉘어 실행될 때
   - 예: i++ 연산은 실제로는 읽기, 증가, 쓰기 세 단계로 나뉨

## 구체적인 예시
```c
// 공유 변수
int balance = 1000;

// 스레드 1
void withdraw(int amount) {
    if (balance >= amount) {
        balance = balance - amount;
    }
}

// 스레드 2
void deposit(int amount) {
    balance = balance + amount;
}
```

위 코드에서 두 스레드가 동시에 실행될 때 다음과 같은 문제가 발생할 수 있습니다:
1. 스레드 1이 balance를 읽음 (1000)
2. 스레드 2가 balance를 읽음 (1000)
3. 스레드 2가 balance + amount를 계산하고 저장
4. 스레드 1이 이전에 읽은 값(1000)을 기준으로 계산하고 저장

## 해결 방법

### 1. 뮤텍스(Mutex)
- 상호 배제를 위한 동기화 도구
- 한 번에 하나의 스레드만 임계 영역에 진입 가능
```c
pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;

void withdraw(int amount) {
    pthread_mutex_lock(&mutex);
    if (balance >= amount) {
        balance = balance - amount;
    }
    pthread_mutex_unlock(&mutex);
}
```

### 2. 세마포어(Semaphore)
- 리소스의 개수를 추적하는 카운터
- 여러 스레드가 동시에 접근 가능하도록 제어
```c
sem_t semaphore;
sem_init(&semaphore, 0, 1); // 초기값 1

void deposit(int amount) {
    sem_wait(&semaphore);
    balance = balance + amount;
    sem_post(&semaphore);
}
```

### 3. 모니터(Monitor)
- 고수준 동기화 구조
- 자바의 synchronized 블록이 대표적인 예시
```java
public synchronized void withdraw(int amount) {
    if (balance >= amount) {
        balance = balance - amount;
    }
}
```

## 레이스 컨디션의 특징

1. **비결정성(Non-deterministic)**
   - 실행할 때마다 결과가 달라질 수 있음
   - 디버깅이 매우 어려움

2. **재현 어려움**
   - 특정 조건에서만 발생
   - 테스트 환경에서는 발견되지 않을 수 있음

3. **심각한 결과**
   - 데이터 손상
   - 시스템 크래시
   - 보안 취약점

## 예방 방법

1. **동기화 도구 사용**
   - 뮤텍스, 세마포어, 모니터 등 적절한 동기화 도구 사용
   - 임계 영역 최소화

2. **불변성(Immutable) 객체 사용**
   - 상태 변경이 불가능한 객체 사용
   - 공유 자원의 수정을 방지

3. **스레드 안전한 자료구조 사용**
   - ConcurrentHashMap
   - CopyOnWriteArrayList
   - BlockingQueue

4. **원자적 연산 사용**
   - AtomicInteger
   - AtomicReference
   - Compare-and-Swap(CAS) 연산

## 실제 사례

1. **은행 시스템**
   - 계좌 이체 시 발생할 수 있는 잔액 불일치
   - 동시 출금으로 인한 마이너스 통장

2. **쇼핑몰 재고 관리**
   - 동시 주문으로 인한 재고 부족
   - 주문 취소와 구매가 동시에 발생할 때의 재고 불일치

3. **멀티플레이어 게임**
   - 아이템 획득/사용 시 발생하는 중복 처리
   - 점수 계산 시 발생하는 누락

## 디버깅 팁

1. **로깅 활용**
   - 상세한 로그 기록
   - 타임스탬프 포함

2. **동기화 검증 도구 사용**
   - ThreadSanitizer
   - Helgrind

3. **단위 테스트 강화**
   - 동시성 테스트 케이스 작성
   - 랜덤 딜레이 추가

4. **코드 리뷰**
   - 동기화 관련 코드 집중 검토
   - 잠재적 레이스 컨디션 식별
