worker_processes auto;

events { worker_connections 1024; }

http {
  include mime.types;

  # 스니펫 include (상대 경로 예시)
  include ../snippets/cache.conf;       # 캐시 존/맵
  include ../snippets/rate_limit.conf;  # 레이트리밋 존

  upstream backend {
    keepalive 64;
    server app1:3000 max_fails=3 fail_timeout=10s;
    server app2:3000 max_fails=3 fail_timeout=10s;
  }

  server {
    listen 80;
    server_name example.local;

    # 보안 헤더(서버 블록에서 include)
    include ../snippets/security_headers.conf;

    location / {
      proxy_pass http://backend;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;

      # 레이트리밋 적용(서버/로케이션 컨텍스트)
      limit_req zone=per_ip burst=20 nodelay;
      limit_conn conn_per_ip 5;

      # 프록시 캐시 적용(원한다면 경로별로 조절)
      proxy_cache            STATIC;
      proxy_cache_key        "$scheme$request_method$host$request_uri";
      proxy_cache_bypass     $bypass_cache;
      proxy_no_cache         $bypass_cache;
      proxy_cache_valid 200 301 302 10m;
      proxy_cache_valid 404 1m;
      proxy_cache_use_stale error timeout updating http_502 http_503 http_504;
      proxy_cache_lock on;

      add_header X-Cache $upstream_cache_status always;
    }
  }
}

